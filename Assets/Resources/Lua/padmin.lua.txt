
local club_id = 0
local room_id = 0

function awake()
	local setBtnEvent = CS.PUtils.setBtnEvent
	local tm = self.transform

	setBtnEvent(tm, "entries/btn_member", onBtnMember)
	setBtnEvent(tm, "entries/btn_history", onBtnHistory)
	setBtnEvent(tm, "entries/btn_message", onBtnMessage)
	setBtnEvent(tm, "top/btn_detail", onBtnDetail)
	setBtnEvent(tm, "bottom/btn_create", onBtnCreate)

	InitEventHandler()
end

function InitEventHandler() 
	local gm = CS.GameMgr
	local gmi = gm.GetInstance()

	gmi:AddHandler("club_room_updated", function(data)
		if self ~= nil and self.mShow then
			refresh()
		end
	end)

	gmi:AddHandler("club_room_removed", function(data)
		if self ~= nil and self.mShow then
			refresh()
		end
	end)

	gmi:AddHandler("club_message_notify", function(data)
		if self ~= nil and self.mShow then
			local notify = gm.sclub_message_notify

			if not notify then return end

			if notify.club_id == club_id then
				setCount(notify.cnt)
			end
		end
	end)
end

function setCount(cnt)
	local show = cnt > 0
	local tm = self.transform
	local utils = CS.PUtils

	utils.setActive(tm, "entries/btn_message/msg_num", show)
	if show then
		utils.setText(tm, "entries/btn_message/msg_num/tile", "" .. cnt)
	end
end

function onBtnDetail()
	CS.PUtils.EnterPage("PClubDetail", club_id)
end

function onBtnMember()
	CS.PUtils.EnterPage("PSetMember", club_id)
end

function onBtnMessage()
	CS.PUtils.EnterPage("PClubMessage", club_id)
end

function onBtnHistory()
	CS.PUtils.EnterPage("PClubHistory", club_id)
end

function onBtnCreate()
	CS.PUtils.EnterPage("PCreateRoom", club_id)
end

function onback()
	local gm = CS.GameMgr
	gm.leave_club_channel(club_id)
	club_id = 0
end

function enterclub(cid, admin)
	club_id = cid

	refresh()

	local gm = CS.GameMgr
	gm.join_club_channel(cid)

	updateMessageCnt()

	self:show()
end

function updateMessageCnt()
	local gm = CS.GameMgr
	gm.get_club_message_cnt(club_id, function(cnt)
		if self ~= nil then
			setCount(cnt)
		end
	end)
end

function refresh()
	if club_id == 0 then
		self:updateItems(0)
		return
	end

	local gm = CS.GameMgr

	gm.list_club_rooms(club_id, function(got)
		if self ~= nil and got then
			showRooms()
		end
	end)
end

function showRooms()
	local gm = CS.GameMgr
	local rooms = gm.slist_club_rooms.data

	local utils = CS.PUtils
	local setActive = utils.setActive
	local setBtnEvent = utils.setBtnEvent
	local setText = utils.setText
	local setIcon = utils.setIcon
	local cnt = rooms.Count

	local show = false

	for i = 0, cnt - 1 do
		local room = rooms[i]
		local item = self:getItem(i)
		local seats = item:Find("seats")
		local ps = room.players
		local readies = 0
		local nplayers = 0
		local idle = room.status == "idle"

		for j = 0, ps.Count - 1 do
			local p = ps[j]
			local s = seats:GetChild(j)
			local empty = p.id == 0

			s.gameObject:SetActive(true)

			setActive(s, "icon", not empty)
			setActive(s, "name", not empty)
			setActive(s, "id", not empty)
			setActive(s, "ready", (not empty) and p.ready)
			setActive(s, "btn_kick", (not empty) and idle)

			if idle then
				if empty then
					setBtnEvent(s, "bghead", function()
						showDetail(room)
					end)
				else
					setBtnEvent(s, "btn_kick", function()
						gm.kick(p.id, room.id, room.room_tag, function(done)
							
						end)
					end)
				end
			end

			if not empty then
				nplayers = nplayers + 1
				if p.ready then readies = readies + 1 end

				setText(s, "name", p.name)
				setText(s, "id", ""..p.id)
				setIcon(s, "icon", p.id)
			end
		end

		local np = ps.Count
		local ns = seats.childCount

		if np < ns then
			for j = np, ns - 1 do
				local s = seats:GetChild(j)
				s.gameObject:SetActive(false)
			end
		end

		local info = room.base_info

		local desc = info:getDesc()

		setText(item, "desc", desc)
		setText(item, "progress", room.num_of_turns .. " / " .. info.maxGames)
		setText(item, "roomid", "ID:" .. room.id)

		local status = "游戏中"
		if idle then status = "开始" end
		setText(item, "status", status)

		local btn_play = item:Find("btn_play")
		local sp = btn_play:GetComponent("SpriteMgr")
		local id = 1
		if idle then id = 0 end
		sp:setIndex(id)

		setBtnEvent(item, "btn_play", function() 
			if idle then
				if readies ~= info.numOfSeats then
					CS.GameAlert.Show("玩家没有全部准备")
					return
				end

				gm.start_room(room.room_tag, function(done)
					if done then refresh() end
				end)
			else
				gm.stop_room(room.room_tag, function(done)
					if done then refresh() end
				end)
			end
		end)

		setActive(item, "btn_edit", idle and nplayers == 0)

		setBtnEvent(item, "btn_edit", function()
				utils.EnterEditRoom(room, refresh)
		end)

		setActive(item, "btn_destroy", idle and nplayers == 0)
		setBtnEvent(item, "btn_destroy", function()
			CS.GameAlert.Show("确定解散房间吗?", function()
				gm.destroy_club_room(room.id, room.room_tag, room.club_id, function(done)
					if done then refresh() end
				end)
			end, true)
		end)

		if room_id == room.id then
			show = true
			showDetail(room)
		end
	end

	if not show then
		room_id = 0
		setActive(self.transform, "detail", false)
	end

	self:updateItems(cnt)
end

function bool_to_word(val)
	if val then
		return "是"
	else
		return "否"
	end
end

function showDetail(room)
	room_id = room.id

	local utils = CS.PUtils
	local setActive = utils.setActive
	local setBtnEvent = utils.setBtnEvent
	local setText = utils.setText
	local setIcon = utils.setIcon

	local tm = self.transform
	local detail = tm:Find("detail")

	setActive(detail, nil, true)

	local seats = detail:Find("seats")
	local grid = seats:GetComponent("UIGrid")

	local players = room.players
	local nseats = players.Count
	local empties = 0

	for i = 0, nseats - 1 do
		local p = players[i]
		local s = seats:GetChild(i)
		local empty = p.id == 0

		setActive(s, nil, true)
		setActive(s, "name", not empty)
		setActive(s, "bghead/icon", not empty)

		setIcon(s, "bghead/icon", p.id)
		setText(s, "name", p.name)
		if empty then
			empties = empties + 1
		end
	end

	for i = nseats, seats.childCount - 1 do
		local s = seats:GetChild(i)
		setActive(s, nil, false)
	end

	grid:Reposition()

	local info = room.base_info
	local type = info.type
	local ops = detail:Find("options")

	setActive(ops, nil, true)
	setText(ops, "playernum", tostring(info.numOfSeats))
	setText (ops, "gamenum", tostring(info.maxGames))

	local rules = ops:Find("rules")

	for i = 0, rules.childCount - 1 do
		rules:GetChild(i).gameObject:SetActive(false)
	end

	local rule = ops:Find("rules/"..type)

	rule.gameObject:SetActive(true)

	if type == "shmj" then
		setText (ops, "rule", "上海敲麻")
		setText (rule, "huafen", tostring(info.huafen))
		setText (rule, "maxfan", tostring(info.maxFan))
		setText (rule, "maima", bool_to_word(info.maima))
		setText (rule, "qidui", bool_to_word(info.qidui))
	elseif type == "gzmj" then
		setText (ops, "rule", "酒都麻将")
		setText (rule, "jyw", bool_to_word(info.jyw))
		setText (rule, "j7w", bool_to_word(info.j7w))
		setText (rule, "ryj", bool_to_word(info.ryj))
	end

	setText (ops, "limit_ip", bool_to_word(info.limit_ip))
	setText (ops, "limit_gps", bool_to_word(info.limit_gps))

	setBtnEvent(detail, "btn_join", function()
		if empties == 0 then
			CS.GameAlert.Show("房间已满，请重新选择")
			return
		end

		local gm = CS.GameMgr.GetInstance()

		gm:enterRoom(room.room_tag, function(code)
			if code ~= 0 then
				local content = "加入房间失败["..code.."]"

				if code == 2224 then
					content = "房间已满！"
				elseif code == 2222 then
					content = "房主钻石不足"
				elseif code == 2231 then
					content = "您的IP和其他玩家相同"
				elseif code == 2232 then
					content = "您的位置和其他玩家太近"
				elseif code == 2233 then
					content = "您的定位信息无效，请检查是否开启定位"
				elseif code == 2251 then
					content = "您不是俱乐部普通成员，无法加入俱乐部房间"
				end

				CS.GameAlert.Show(content)
			end
		end)

	end)

	setBtnEvent(detail, "btn_back", function()
		room_id = 0
		setActive(detail, nil, false)
	end)
end

